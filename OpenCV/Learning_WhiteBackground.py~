import sys
import time
import cv2
import numpy as np
import cmath
import os
from matplotlib import pyplot as plt

def perimeter(points):
	length = 0
	for element in points:
		for e in element:
			a = e[0]
			b = e[1]
			c = (a**2)+(b**2)
			c = c**0.5
			length = length + c
	return(length)

def getContours(image,mask):
	orig = image.copy()
	mask = np.array(mask * 255, dtype = np.uint8)
	contours, hierarchy = cv2.findContours(mask,cv2.RETR_LIST,cv2.CHAIN_APPROX_NONE)
	sizes = []
	for i in range(len(contours)):
		perim = perimeter(contours[i])
		sizes.append([perim,i])
	sizes.sort(key=lambda x: x[0],reverse=True)
	contour = contours[sizes[0][1]]
	cv2.drawContours(image, contour, -1, (0,0,255), 3)
	return (image,contour)

def maskImage(image):
	thresh = 125
	height, width, channels = image.shape
	mask = np.zeros( (height,width) )
	i = 0
	for i in range(len(image)):
		row = image[i]
		j = 0
		for j in range(len(row)):
			pixel = row[j]
			total = abs(255 - int(pixel[0])) + abs(255-int(pixel[1])) + abs(255-int(pixel[2]))
			if ( total > thresh):
				mask[i][j] = 1
			j += 1
		i += 1
	cv2.destroyAllWindows()
	return (mask)

def getColor(mask,image):
	pixels = 0
	b = 0
	g = 0
	r = 0
	for i in range(len(mask)):
		mask_row = mask[i]
		row = image[i]
		for j in range(len(mask_row)):
			mask_column = mask_row[j]
			column = row[j]
			if (mask_column == 1):
				pixels += 1
				b = b + column[0]
				g = g + column[1]
				r = r + column[2]
	b_avg = b / pixels
	g_avg = g / pixels
	r_avg = r / pixels
	return (b_avg, g_avg, r_avg)

def processImage(image,output_file = 'all_data.csv',object_id = 39):
	img = None
	if (str(type(image))=='<type \'str\'>'):
		img = cv2.imread(image)
	if (str(type(image))=='<type \'numpy.ndarray\'>'):
		img = image.copy()
	height, width, channels = img.shape
	orig = img.copy()
	mask = maskImage(img)
	img, contour = getContours(img,mask)
	b, g, r = getColor(mask,img)
	color = orig.copy()
	i = 0
	for i in range(len(color)):
		row = color[i]
		j = 0
		for j in range(len(row)):
			color[i][j][0] = b
			color[i][j][1] = g
			color[i][j][2] = r
	cv2.imshow('original',orig)
	cv2.moveWindow('original',0,0)
	cv2.imshow('mask',mask)
	cv2.moveWindow('mask',0,height + 50)
	cv2.imshow('img',img)
	cv2.moveWindow('img',width + 50 ,0)
	cv2.imshow('color',color)
	cv2.moveWindow('color',width + 50,height + 50)
	convex_hull = cv2.convexHull(contour,returnPoints=True)
	total_convex = (perimeter(contour))/ (perimeter(convex_hull))
	output = str(object_id) + ',' + str(total_convex) + ',' + str(b) + ',' + str(g) + ',' + str(r) + '\n'
	print (output)
	print ('ENTER - Write data to file\Any other key - Cancel')
	key_pressed = cv2.waitKey(0)
	cv2.destroyAllWindows()
	if (key_pressed == 10):
		f = open(output_file,'a')
		f.write(output)
		print ('data written to file')
		

def main(obj_id,fp):
	print ('\nLeft/Right: Change image to process\n')
	while (True):
		files = os.listdir(fp)
		i = 0
		while (i < len(files)):
			image = fp + files[i]
			img = cv2.imread(image)
			cv2.imshow('select image to process',img)
			cv2.moveWindow('select image to process',0,0)
			key_pressed = cv2.waitKey(0)
			if ( key_pressed == 10):
				cv2.destroyAllWindows()
				processImage(img,'all_data.csv',obj_id)
			if ( key_pressed == 65363):
				i = i + 1
				cv2.destroyAllWindows()
			if ( key_pressed == 65361):
				if (i>0):
					i = i - 1
				else:
					i = len(files)-1
				cv2.destroyAllWindows()
			if ( key_pressed == 27):
				cv2.destroyAllWindows()
				return

fp = os.path.dirname(__file__) + 'images/test/'	
obj_id = 39
if (len(sys.argv)>2):
	obj_id = sys.argv[1]
	fp = sys.argv[2]
elif (len(sys.argv)>1):
	obj_id = sys.argv[1]
main(obj_id,fp)
exit()







